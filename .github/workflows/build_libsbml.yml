name: Build libsbml

on:
  push:
  release:
    types: [created]
    
jobs:

  build_linux:
    strategy:
      matrix:
        os: [
          {image: ubuntu-22.04, glibc: "2.35"}, 
          {image: ubuntu-24.04, glibc: "2.39"}
        ]
    runs-on: ${{ matrix.os.image }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Compile libSBML dependencies
      run: |
        git clone --recurse-submodules https://github.com/sbmlteam/libSBML-dependencies.git
        cd libSBML-dependencies
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DWITH_LIBXML=ON \
          -DWITH_ZLIB=ON \
          -DWITH_ICONV=ON \
          -DWITH_BZIP2=ON \
          -DWITH_CHECK=OFF \
          -DLIBXML2_WITH_ZLIB=ON
        cmake --build build --parallel 4
        sudo cmake --install build
    
    - name: Compile libSBML
      run: |
        wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v5.20.5.tar.gz
        tar -zxf v5.20.5.tar.gz
        cd libsbml-5.20.5
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=/usr/lib \
        -DCMAKE_CXX_COMPILER=g++ \
        -DCMAKE_C_COMPILER=gcc \
        -DCMAKE_CXX_STANDARD_LIBRARIES=-lxml2 \
        -DWITH_SWIG=OFF \
        -DLIBXML_LIBRARY=/usr/lib/x86_64-linux-gnu/libxml2.a \
        -DLIBXML_INCLUDE_DIR=/usr/include/libxml2 \
        -DENABLE_COMP=ON \
        -DENABLE_FBC=ON \
        -DENABLE_GROUPS=ON \
        -DENABLE_LAYOUT=ON \
        -DENABLE_MULTI=ON \
        -DENABLE_QUAL=ON \
        -DENABLE_RENDER=ON \
        -DENABLE_DISTRIB=ON \
        -DWITH_CPP_NAMESPACE=ON \
        -DBUILD_SHARED_LIBS=OFF \
        ..
        make -j 4
        sudo make install
        cd ..
        mkdir package
        cd package
        mkdir lib
        cp /usr/lib/libsbml-static.a /usr/lib/libzlib.a /usr/lib/libbz2.a /usr/lib/x86_64-linux-gnu/libxml2.a lib/
        
        mkdir include
        cp -r /usr/include/sbml/ include/
        tar -zcvf ../libSBML-5.20.5-linux64-glibc${{ matrix.os.glibc }}.tar.gz *

    - uses: actions/upload-artifact@v4
      with:
        name: libSBML-5.20.5-linux64-glibc${{ matrix.os.glibc }}
        path: /home/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/package/*
          
      
    - uses: actions/upload-release-asset@v1
      if: github.event_name == 'release'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_name: libSBML-5.20.5-linux64-glibc${{ matrix.os.glibc }}.tar.gz
        asset_path: /home/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/libSBML-5.20.5-linux64-glibc${{ matrix.os.glibc }}.tar.gz
        asset_content_type: application/gzip   
               
  build_macosx:
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Compile libSBML dependencies
      run: |
        git clone --recurse-submodules https://github.com/sbmlteam/libSBML-dependencies.git
        cd libSBML-dependencies
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++-12 \
          -DCMAKE_C_COMPILER=gcc-12 \
          -DCMAKE_INSTALL_PREFIX=/usr/local/ \
          -DWITH_LIBXML=ON \
          -DWITH_ZLIB=ON \
          -DWITH_ICONV=ON \
          -DWITH_BZIP2=ON \
          -DWITH_CHECK=OFF \
          -DLIBXML2_WITH_ZLIB=ON
        cmake --build build --parallel 4
        sudo cmake --install build
          
    - name: Compile libSBML
      env: 
        MACOSX_DEPLOYMENT_TARGET: 13.0
      run: |
        wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v5.20.5.tar.gz
        tar -zxf v5.20.5.tar.gz
        cd libsbml-5.20.5
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local/ \
        -DCMAKE_INSTALL_LIBDIR=/usr/local/lib/ \
        -DCMAKE_CXX_COMPILER=g++-12 \
        -DCMAKE_C_COMPILER=gcc-12 \
        -DCMAKE_CXX_STANDARD_LIBRARIES=-lxml2 \
        -DWITH_SWIG=OFF \
        -DLIBXML_LIBRARY=/usr/local/lib/libxml2.a \
        -DLIBXML_INCLUDE_DIR=/usr/local/include/libxml2 \
        -DENABLE_COMP=ON \
        -DENABLE_FBC=ON \
        -DENABLE_GROUPS=ON \
        -DENABLE_LAYOUT=ON \
        -DENABLE_MULTI=ON \
        -DENABLE_QUAL=ON \
        -DENABLE_RENDER=ON \
        -DENABLE_DISTRIB=ON \
        -DWITH_CPP_NAMESPACE=ON \
        -DBUILD_SHARED_LIBS=OFF \
        ..
        make -j 4
        sudo make install
        cd ..
        mkdir package
        cd package
        mkdir lib
        cp /usr/local/lib/libsbml-static.a /usr/local/lib/libzlib.a /usr/local/lib/libbz2.a /usr/local/lib/libxml2.a lib/
        mkdir include
        cp -r /usr/local/include/sbml include/
        tar -zcvf ../libSBML-5.20.5-osx-x86_64.tar.gz *

    - uses: actions/upload-artifact@v4
      with:
        name: libSBML-5.20.5-osx-x86_64
        path: /Users/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/package/*
        
      
    - uses: actions/upload-release-asset@v1
      if: github.event_name == 'release'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_name: libSBML-5.20.5-osx-x86_64.tar.gz
        asset_path: /Users/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/libSBML-5.20.5-osx-x86_64.tar.gz
        asset_content_type: application/gzip   
        
  build_macosx_m1:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Compile libSBML dependencies
      run: |
        git clone --recurse-submodules https://github.com/sbmlteam/libSBML-dependencies
        cd libSBML-dependencies
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DCMAKE_CXX_COMPILER=g++-13 \
          -DCMAKE_C_COMPILER=gcc-13 \
          -DWITH_LIBXML=ON \
          -DWITH_ZLIB=ON \
          -DWITH_ICONV=ON \
          -DWITH_BZIP2=ON \
          -DWITH_CHECK=OFF \
          -DLIBXML2_WITH_ZLIB=ON
        cmake --build build --parallel 4
        sudo cmake --install build
    
    - name: Compile libSBML
      env: 
        MACOSX_DEPLOYMENT_TARGET: 14.0
      run: |
        wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v5.20.5.tar.gz
        tar -zxf v5.20.5.tar.gz
        cd libsbml-5.20.5
        mkdir build
        cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local/ \
        -DCMAKE_INSTALL_LIBDIR=/usr/local/lib/ \
        -DCMAKE_CXX_COMPILER=g++-13 \
        -DCMAKE_C_COMPILER=gcc-13 \
        -DCMAKE_CXX_STANDARD_LIBRARIES=-lxml2 \
        -DWITH_SWIG=OFF \
        -DLIBXML_LIBRARY=/usr/local/lib/libxml2.a \
        -DLIBXML_INCLUDE_DIR=/usr/local/include/libxml2/ \
        -DENABLE_COMP=ON \
        -DENABLE_FBC=ON \
        -DENABLE_GROUPS=ON \
        -DENABLE_LAYOUT=ON \
        -DENABLE_MULTI=ON \
        -DENABLE_QUAL=ON \
        -DENABLE_RENDER=ON \
        -DENABLE_DISTRIB=ON \
        -DWITH_CPP_NAMESPACE=ON \
        -DBUILD_SHARED_LIBS=OFF \
        ..
        make -j 3
        sudo make install
        cd ..
        mkdir package
        cd package
        mkdir lib
        cp /usr/local/lib/libsbml-static.a /usr/local/lib/libzlib.a /usr/local/lib/libbz2.a /usr/local/lib/libxml2.a lib/
        mkdir include
        cp -r /usr/local/include/sbml include/
        tar -zcvf ../libSBML-5.20.5-osx-arm64.tar.gz *
        
    - uses: actions/upload-artifact@v4
      with:
        name: libSBML-5.20.5-osx-arm64
        path: /Users/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/package/*
        
    - uses: actions/upload-release-asset@v1
      if: github.event_name == 'release'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_name: libSBML-5.20.5-osx-arm64.tar.gz
        asset_path: /Users/runner/work/intracellular_libs/intracellular_libs/libsbml-5.20.5/libSBML-5.20.5-osx-arm64.tar.gz
        asset_content_type: application/gzip   
                        
  build_windows:
    runs-on: windows-latest
    
    defaults:
      run:
        shell: msys2 {0}
        
    steps:
    - uses: actions/checkout@v4
    
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: flex bison make git mingw-w64-x86_64-binutils mingw-w64-x86_64-gcc mingw-w64-x86_64-headers-git mingw-w64-x86_64-gcc-libs mingw-w64-x86_64-libwinpthread-git mingw-w64-x86_64-python mingw-w64-x86_64-python-zstandard mingw-w64-x86_64-python-cffi make bison flex mingw-w64-x86_64-ca-certificates mingw-w64-x86_64-diffutils mingw-w64-x86_64-python-pip mingw-w64-x86_64-python-numpy mingw-w64-x86_64-lapack mingw-w64-x86_64-openblas mingw-w64-x86_64-cmake mingw-w64-x86_64-tools-git
    
    - name: Compile libSBML dependencies
      run: |
        git clone --recurse-submodules https://github.com/sbmlteam/libSBML-dependencies.git
        cd libSBML-dependencies
        cmake -G"MSYS Makefiles" -B build -S . \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_INSTALL_PREFIX=/mingw64 \
          -DWITH_LIBXML=ON \
          -DWITH_ZLIB=ON \
          -DWITH_ICONV=ON \
          -DWITH_BZIP2=ON \
          -DWITH_CHECK=OFF \
          -DLIBXML2_WITH_ZLIB=ON
        cmake --build build --parallel 4 -v
        cmake --install build
    
        
    - name: Compiling libSBML
      run: |
        wget https://github.com/sbmlteam/libsbml/archive/refs/tags/v5.20.5.tar.gz
        tar -zxf v5.20.5.tar.gz
        cd libsbml-5.20.5
        
        #Hacky fix for gcc 15
        sed -i '10i #include <cstdint>' ./src/sbml/html2md/html2md.h

        mkdir build
        cd build        
        
        cmake  -G"MSYS Makefiles" \
          -DCMAKE_INSTALL_PREFIX=/mingw64/ \
          -DCMAKE_INSTALL_LIBDIR=/mingw64/lib \
          -DCMAKE_CXX_COMPILER=g++ \
          -DCMAKE_C_COMPILER=gcc \
          -DCMAKE_CXX_STANDARD_LIBRARIES=-lxml2 \
          -DWITH_SWIG=OFF \
          -DLIBXML_LIBRARY=/mingw64/lib/libxml2.a \
          -DLIBXML_INCLUDE_DIR=/mingw64/include/libxml2 \
          -DENABLE_COMP=ON \
          -DENABLE_FBC=ON \
          -DENABLE_GROUPS=ON \
          -DENABLE_LAYOUT=ON \
          -DENABLE_MULTI=ON \
          -DENABLE_QUAL=ON \
          -DENABLE_RENDER=ON \
          -DENABLE_DISTRIB=ON \
          -DBUILD_SHARED_LIBS=OFF \
          ..
        make VERBOSE=1 -j 4
        make install
        cd ..
        mkdir package
        cd package
        mkdir lib
        cp D:/a/_temp/msys64/mingw64/lib/libsbml-static.a D:/a/_temp/msys64/mingw64/lib/liblibbz2.a D:/a/_temp/msys64/mingw64/lib/libzdll.a D:/a/_temp/msys64/mingw64/lib/libxml2.a lib/
        mkdir include
        cp -r D:/a/_temp/msys64/mingw64/include/sbml/ include/
        tar -zcvf ../libSBML-5.20.5-win64.tar.gz *
        
    - uses: actions/upload-artifact@v4
      with:
        name: libSBML-5.20.5-win64
        path: D:\a\intracellular_libs\intracellular_libs/libsbml-5.20.5/package/*
        
    - uses: actions/upload-release-asset@v1
      if: github.event_name == 'release'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_name: libSBML-5.20.5-win64.tar.gz
        asset_path: D:\a\intracellular_libs\intracellular_libs\libsbml-5.20.5\libSBML-5.20.5-win64.tar.gz
        asset_content_type: application/gzip     